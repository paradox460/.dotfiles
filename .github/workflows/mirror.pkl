amends "https://cdn.jsdelivr.net/gh/StefMa/pkl-gha@main/Workflow.pkl"
import "https://cdn.jsdelivr.net/gh/StefMa/pkl-gha@main/Action.pkl"
import "https://cdn.jsdelivr.net/gh/paradox460/shared-pkl@main/gha/ssh_key.pkl"

name = "Sync Mirrors"

on {
  push {}
}

jobs {
  ["mirror"] = new {
    `runs-on` = "ubuntu-latest"
    env = new EnvironmentVariables {
      ["SSH_AUTH_SOCK"] = "/tmp/ssh_agent.sock"
    }
    steps {
      (Action.checkout) {
        fetchDepth = 0
      }
      (ssh_key.SSHKey) {
        secret_name = "TANGLED_SSH_KEY"
        remote_host = "tangled.sh"
      }
      new {
        name = "Push to mirrors"
        run = """
          git remote add tangled git@tangled.sh:paradox.tngl.sh/dotfiles
          git push --all --force tangled
        """
      }
    }
  }
}
